# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: run tests and generate a tag

on:
  push: 
    tags: 
      - v[0-9]+.[0-9]+.*
    branches: [ github-actions-CI/CD ]




jobs:
  upload-to-docker-hub:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1

        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_HUB_USERNAME }}
            password: ${{ secrets.DOCKER_HUB_PASSWORD }}

        - name: Get variables
          id: get_variables
          run: |
            echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
            echo ::set-output name=IS_PRERELEASE::"${{contains(github.ref, 'dev')}}"

        - name: Publish release github
          uses: softprops/action-gh-release@v1
          with:
            token: ${{ secrets.GIT_TOKEN }}
            prerelease: ${{ steps.get_variables.outputs.IS_PRERELEASE }}
            tag_name: ${{ steps.get_variables.outputs.VERSION }}

        - name: Build and push Docker image
          run: |
            docker buildx create --use
            docker buildx build -t javifdez7/programaze:${{ steps.get_variables.outputs.VERSION }} -f Dockerfile.prod .
            docker push javifdez7/programaze:${{ steps.get_variables.outputs.VERSION }}
