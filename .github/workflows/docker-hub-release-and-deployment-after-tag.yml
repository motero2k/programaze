# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# GitHub recommends pinning actions to a commit SHA.
# To get a newer version, you will need to update the SHA.
# You can also reference a tag or branch, but the action may change without warning.

name: run tests and generate a tag

on:
  push: 
    tags: 
      - v*.*.*


jobs:
  upload-to-docker-hub:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1

        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_HUB_USERNAME }}
            password: ${{ secrets.DOCKER_HUB_PASSWORD }}

        - name: Get variables
          id: get_variables
          run: |
            echo "VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV
            echo "IS_PRERELEASE=${{contains(github.ref, 'dev')}}" >> $GITHUB_ENV
          shell: bash
          
        - name: Publish release github
          uses: softprops/action-gh-release@v1
          with:
            token: ${{ secrets.GIT_TOKEN }}
            prerelease: ${{ env.IS_PRERELEASE }}
            tag_name: ${{ env.VERSION }}
            body: New version

        - name: Build and push Docker image
          run: |
            docker buildx create --use
            docker buildx build -t javifdez7/programaze:${{ env.VERSION }} -f Dockerfile.prod .
            docker push javifdez7/programaze:${{ env.VERSION }}

